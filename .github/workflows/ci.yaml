name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run ruff linter
        run: ruff check scripts/ tests/

      - name: Run ruff formatter check
        run: ruff format --check scripts/ tests/

      - name: Run mypy type checking
        run: mypy scripts/ --ignore-missing-imports

      - name: Run unit tests
        run: pytest tests/ --ignore=tests/test_integration.py -v

      - name: Validate manifest schema (if exists)
        run: |
          if [ -f "data/manifests/manifest.csv" ]; then
            python -c "
          import csv
          import sys

          required_cols = [
              'id', 'song_name', 'audio_relpath', 'midi_relpath',
              'audio_sha256', 'midi_sha256', 'audio_ext', 'midi_ext',
              'has_emotional_variations', 'emotion', 'notes'
          ]

          with open('data/manifests/manifest.csv', 'r') as f:
              reader = csv.DictReader(f)
              cols = reader.fieldnames or []
              missing = [c for c in required_cols if c not in cols]
              if missing:
                  print(f'Missing columns: {missing}')
                  sys.exit(1)
              print('Manifest schema valid')
          "
          else
            echo "Manifest not found, skipping schema validation"
          fi

  full-validation:
    name: Full Dataset Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: lint-and-test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install dvc[gdrive]

      - name: Configure DVC
        run: |
          dvc remote modify company-gdrive --local gdrive_use_service_account true
          echo '${{ secrets.GDRIVE_CREDENTIALS }}' > /tmp/gdrive-credentials.json
          dvc remote modify company-gdrive --local gdrive_service_account_json_file_path /tmp/gdrive-credentials.json
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}

      - name: Pull data from DVC
        run: dvc pull
        continue-on-error: true

      - name: Run validation script
        run: |
          if [ -d "data/raw/audio" ] && [ -d "data/raw/midi" ]; then
            python scripts/validate_dataset.py
          else
            echo "Data not available, skipping validation"
          fi

      - name: Run MIDI health checks
        run: |
          if [ -d "data/raw/midi" ]; then
            python scripts/check_midi_health.py data/raw/midi/ -o reports/midi_health.json
          else
            echo "MIDI data not available, skipping health checks"
          fi

      - name: Run audio health checks
        run: |
          if [ -d "data/raw/audio" ]; then
            python scripts/check_audio_health.py data/raw/audio/ -o reports/audio_health.json
          else
            echo "Audio data not available, skipping health checks"
          fi

      - name: Run integration tests
        run: |
          if [ -d "data/raw/audio" ] && [ -d "data/raw/midi" ]; then
            pytest tests/test_integration.py -v
          else
            echo "Data not available, skipping integration tests"
          fi

      - name: Upload health reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: health-reports
          path: reports/
          retention-days: 30
